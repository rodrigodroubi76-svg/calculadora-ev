{% extends "admin_layout.html" %}
{% block title %}Simulador Comparativo{% endblock %}

{% block content %}
<div class="container">
    <div class="form-card">
        <h1>Comparativo de Carregadores</h1>
        <p>Selecione o veículo e seus dados de custo. Mostraremos o tempo de recarga e o custo-benefício de todos os carregadores compatíveis.</p>
        
        <form action="/simular" method="POST">
            <div class="form-grid">
                <div>
                    <label for="veiculo">Veículo Elétrico:</label>
                    <select id="veiculo" name="veiculo_id" required>
                        <option value="">-- Selecione um Veículo --</option>
                        {% for v in veiculos %}
                            <option value="{{ v.id }}" 
                                {% if veiculo_selecionado and veiculo_selecionado.id == v.id %} 
                                    selected 
                                {% endif %}>
                                {{ v.nome_completo }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="custo_kwh">Custo do kWh (R$):</label>
                    <input type="number" step="0.01" id="custo_kwh" name="custo_kwh" 
                           value="{{ custos_info.custo_kwh if custos_info else '0.80' }}" required>
                </div>
                
                <div>
                    <label for="recargas_mes">Número de Recargas por Mês (20% a 80%):</label>
                    <input type="number" step="1" id="recargas_mes" name="recargas_mes" 
                           value="{{ custos_info.recargas_mes if custos_info else '20' }}" required>
                </div>
            </div>
            
            <button type"submit" style="margin-top: 20px;">Gerar Relatório Comparativo</button>
        </form>
    </div>

    {% if resultados_comparativos %}
    <div class="form-card">
        <h2>Resultados para: {{ veiculo_selecionado.nome_completo }}</h2>

        <h3>Estimativa de Gastos (para {{ custos_info.recargas_mes }} recargas/mês)</h3>
        <p>
            <strong>Custo por Recarga (20% a 80%):</strong> R$ {{ custos_gerais.custo_por_recarga | round(2) }} <br>
            <strong>Gasto Mensal:</strong> R$ {{ custos_gerais.custo_mensal | round(2) }} <br>
            <strong>Gasto Anual:</strong> R$ {{ custos_gerais.custo_anual | round(2) }}
        </p>
        <hr>
        <h3>Relatório Comparativo de Carregadores</h3>
        <style>
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
            th { background-color: #f0f0f0; }
            tr.best-choice { background-color: #d4edda; font-weight: bold; }
            tr.best-choice td:first-child::after { content: " ⭐ Melhor Custo-Benefício"; color: #155724; }
            tr.incompatible { background-color: #f8d7da; color: #721c24; text-decoration: line-through; }
        </style>
        <table>
            <thead>
                <tr>
                    <th>Carregador (Marca/Modelo/Tipo)</th>
                    <th>Potência Efetiva</th>
                    <th>Tempo de Recarga (20% a 80%)</th>
                    <th>Preço do Carregador</th>
                </tr>
            </thead>
            <tbody>
                {% for res in resultados_comparativos %}
                    <tr class="{% if loop.first %}best-choice{% endif %}">
                        <td>
                            {{ res.carregador.marca }} {{ res.carregador.modelo }} 
                            (<strong>{{ res.carregador.tipo_corrente }}</strong>)
                        </td>
                        <td>{{ res.potencia_efetiva_kw | round(1) }} kW</td>
                        <td>{{ res.tempo_recarga_horas | round(2) }} horas</td>
                        <td>R$ {{ res.carregador.preco | round(2) }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        <small style="margin-top: 10px; display: block;">
            * Carregadores incompatíveis (ex: Carregador DC para um carro que só aceita AC) não são exibidos.<br>
            * O <strong>Melhor Custo-Benefício</strong> é calculado com base no menor preço por kW de potência efetiva (Preço / Potência Efetiva).
        </small>
    </div>
    {% endif %}
    
</div>
{% endblock %}